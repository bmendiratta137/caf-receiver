<!DOCTYPE html>
<html>
<head>
    <!-- New Relic Video -->
    <script src="../dist/newrelic-caf.min.js"></script>

    <!-- CAF Receiver SDK -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <title>Cast Videos: Google Cast Chrome Sender SDK Demo App</title>
    <link rel="icon" type="image/x-icon" href="imagefiles/favicon.ico" />
    <link rel="icon" type="image/png" href="imagefiles/favicon-16x16.png" />
    <link rel="icon" type="image/png" href="imagefiles/favicon-16x16.png" />
    <link rel="icon" type="image/png" href="imagefiles/favicon-32x32.png" />
    <link rel="icon" type="image/png" href="imagefiles/favicon-64x64.png" />
    <link rel="stylesheet" type="text/css" href="css/CastVideos.css">
    <link href='//fonts.googleapis.com/css?family=Roboto&subset=latin,cyrillic-ext,greek-ext,latin-ext' rel='stylesheet' type='text/css'>
</head>
<body>
  <cast-media-player id="media-player"></cast-media-player>

  <script src="CastVideos.js" type="module"></script>
  <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
  <script>
    // Initialize New Relic Video Tracker
    const videoElement = document.getElementsByTagName('cast-media-player')[0];
    const newRelicTracker = new NewRelicVideoTracker({
        licenseKey: 'NRBR-940177a1ae3f2107673',
        applicationID: '601520543',
        videoElement: videoElement // Make sure this references the correct element
    });
    console.log('New Relic Tracker initialized');

    // Initialize Cast Application Framework
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    playerManager.addEventListener(cast.framework.events.EventType.PLAYER_LOAD_COMPLETE, () => {
        newRelicTracker.trackLoad();
        console.log('PLAYER_LOAD_COMPLETE event tracked');
    });

    playerManager.addEventListener(cast.framework.events.EventType.PLAY, () => {
        newRelicTracker.trackPlay();
        console.log('PLAY event tracked');
    });

    playerManager.addEventListener(cast.framework.events.EventType.PAUSE, () => {
        newRelicTracker.trackPause();
        console.log('PAUSE event tracked');
    });

    playerManager.addEventListener(cast.framework.events.EventType.ENDED, () => {
        newRelicTracker.trackEnd();
        console.log('ENDED event tracked');
    });

    playerManager.addEventListener(cast.framework.events.EventType.ERROR, (event) => {
        newRelicTracker.trackError(event);
        console.error('ERROR event tracked', event);
    });

    // Start the Cast Receiver
    context.start();

    // Set logging level (show all messages)
    cast.framework.CastReceiverContext.getInstance().setLoggerLevel(cast.framework.LoggerLevel.DEBUG);

    // Capture JS errors
    window.onerror = function (msg, url, line) {
        console.log("Message: " + msg);
        console.log("URL: " + url);
        console.log("Line number: " + line);
        newrelic.addPageAction("JSError", {"errMessage": msg, "errUrl": url, "errLine": line})
    }
  </script>
</body>
</html>